
<html lang="es" ng-app="recordingApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Grabaciones MIDI y Audio</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet"/>
    
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/es6/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/focus-visible@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-midi-player@1.5.0"></script>
    
    <style>
        /* ESTILOS ORIGINALES DEL GESTOR */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid #e5e5e7; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-icon { width: 56px; height: 56px; background: linear-gradient(135deg, #8B5CF6, #A855F7); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .header-info h1 { font-size: 24px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px; }
        .header-info p { color: #6e6e73; font-size: 16px; }
        .actions-container { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 10px; flex-wrap: wrap; gap: 10px;}
        .record-controls-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .recordOptions { display: flex; gap: 15px; align-items: center; }
        #midiStatus { font-size: 12px; color: #6e6e73; text-align: right; min-height: 16px; }
        .add-button { background-color: #8a2be2; color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .add-button:hover { background-color: #7b24c6; }
        .add-button.recording { background-color: #e53935; animation: pulse-record 1.5s infinite; }
        .add-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        @keyframes pulse-record { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .filters { display: flex; gap: 15px; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-weight: 600; color: #1d1d1f; font-size: 14px; }
        .filter-select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; background: white; color: #374151; font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
        .filter-select:focus { outline: none; border-color: #8B5CF6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
        .search-box { flex: 1; max-width: 300px; position: relative; }
        .search-input { width: 100%; padding: 12px 16px 12px 44px; border: 1px solid #d1d5db; border-radius: 12px; background: white; font-size: 14px; transition: all 0.2s ease; }
        .search-input:focus { outline: none; border-color: #8B5CF6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #6b7280; }
        .recordings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .recording-card { background: white; border-radius: 16px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid #e5e5e7; transition: all 0.2s ease; }
        .recording-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12); }
        .recording-header { padding: 20px; display: flex; align-items: flex-start; gap: 16px; cursor: pointer; }
        .recording-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .recording-icon.midi { background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; }
        .recording-icon.audio { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
        .recording-info { flex: 1; min-width: 0; }
        .recording-title { font-size: 16px; font-weight: 600; color: #1d1d1f; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .recording-meta { display: flex; flex-direction: column; gap: 2px; }
        .recording-date, .recording-genre { font-size: 13px; color: #6e6e73; }
        .recording-duration { font-size: 13px; color: #8B5CF6; font-weight: 500; }
        .recording-actions { padding: 0 20px 20px; display: flex; justify-content: space-between; align-items: center; }
        .play-controls { display: flex; gap: 8px; align-items: center; }
        .play-btn { width: 40px; height: 40px; border-radius: 50%; border: none; font-size: 16px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .play-btn:hover { transform: scale(1.05); }
        .play-btn.playing { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .play-btn.midi { background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; }
        .play-btn.audio { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
        .waveform-btn { padding: 8px 12px; border: 1px solid #8B5CF6; border-radius: 8px; background: rgba(139, 92, 246, 0.05); color: #8B5CF6; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .waveform-btn:hover { background: rgba(139, 92, 246, 0.1); }
        .waveform-btn-audio { padding: 8px 12px; border: 1px solid #06b6d4; border-radius: 8px; background: rgba(6, 182, 212, 0.05); color: #0891b2; font-size: 12px; font-weight: 500; }
        .menu-actions { position: relative; }
        .menu-btn { width: 32px; height: 32px; border: none; background: #f3f4f6; border-radius: 8px; color: #6b7280; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .menu-btn:hover { background: #e5e7eb; color: #374151; }
        .progress-bar { width: calc(100% - 40px); margin: 0 20px 16px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; cursor: pointer; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #8B5CF6, #A855F7); border-radius: 3px; width: 0%; transition: width 0.1s linear; pointer-events: none; }
        .progress-fill.audio { background: linear-gradient(90deg, #06b6d4, #0891b2); }
        .empty-state { text-align: center; padding: 60px 20px; color: #6e6e73; grid-column: 1 / -1; }
        .dropdown-menu { position: absolute; right: 0; top: 40px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e5e5e7; z-index: 1000; overflow: hidden; display: none; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px 16px; color: #374151; font-size: 14px; cursor: pointer; white-space: nowrap; }
        .dropdown-item:hover { background: #f3f4f6; }
        .dropdown-item.delete { color: #dc2626; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background: white; color: black; border-radius: 16px; width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #e5e7eb; }
        .modal-title { font-size: 18px; font-weight: 600; color: #1d1d1f; }
        .modal-title .title-text { font-weight: 400; margin-left: 8px; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle; }
        .modal-close-btn { background: none; border: none; color: #6b7280; font-size: 24px; cursor: pointer; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: #dc2626; }
        .visualizer-container { flex-grow: 1; padding: 0; overflow: hidden; }
        midi-visualizer { width: 100%; height: 100%; }
        .player-container { padding: 10px 24px; background: white; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }
        midi-player { width: 100%; display: block; }
        #recordingReviewModal .modal-content, #audioReviewModal .modal-content { max-width: 700px; max-height: none; height: auto; }
        #recordingReviewModal p, #audioReviewModal p { padding: 0 24px 16px; color: #6e6e73; }
        #recordingReviewModal .visualizer-container { padding: 24px; background-color: #f9f9f9; }
        #recordingReviewModal midi-visualizer { height: 200px; border: 1px solid #ddd; border-radius: 8px; }
        #audioReviewModal .audio-player-container { padding: 24px; }
        #audioReviewPlayer { width: 100%; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 24px; border-top: 1px solid #e5e7eb; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
        .modal-btn-discard { background-color: #ef4444; color: white; }
        .modal-btn-discard:hover { background-color: #dc2626; }
        .modal-btn-save { background-color: #22c55e; color: white; }
        .modal-btn-save:hover { background-color: #16a34a; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 0; }
            .header { flex-direction: column; align-items: flex-start; }
            .search-box { max-width: none; }
            .recordings-grid { grid-template-columns: 1fr; gap: 16px; padding: 0 10px; }
            .actions-container { flex-direction: column; align-items: stretch; }
            .record-controls-wrapper { align-items: stretch; text-align: center; }
            #midiStatus { text-align: center; }
        }
    </style>
</head>
<body ng-controller="recordingCtrl">
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-icon"><i class="fas fa-record-vinyl"></i></div>
                <div class="header-info">
                    <h1>Mis Grabaciones</h1>
                    <p>Gestiona y reproduce tus grabaciones</p>
                </div>
            </div>
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar grabaciones..." ng-model="filters.title">
            </div>
        </div>

        <div class="actions-container">
            <div class="filters">
                <div class="filter-group filter-date">
                    <span class="filter-label">Ordenar por:</span>
                    <select class="filter-select" ng-model="sortOrder">
                        <option value="-date">Fecha (recientes)</option>
                        <option value="date">Fecha (antiguos)</option>
                        <option value="title">Nombre</option>
                        <option value="duration">Duración</option>
                    </select>
                </div>
            </div>
            <div class="record-controls-wrapper">
                <div class="recordOptions">
                    <select id="deviceSelector" class="filter-select">
                        <option value="">-- Conectando a MIDI --</option>
                    </select>
                    <button class="add-button" id="recordBtn" disabled>
                        <i id="recordIcon" class="fas fa-circle-notch fa-spin"></i> <span id="recordBtnSpan"></span>
                    </button>
                </div>
                 <div id="midiStatus"></div>
            </div>
        </div>

        <div class="recordings-grid">
            <div class="recording-card" ng-repeat="rec in recordings | filter:filters | orderBy:sortOrder">
                <div class="recording-header" ng-click="playPause(rec, $event)">
                    <div class="recording-icon" ng-class="{'midi': rec.type === 'midi', 'audio': rec.type === 'audio'}">
                        <i class="fas" ng-class="{'fa-music': rec.type === 'midi', 'fa-microphone-alt': rec.type === 'audio'}"></i>
                    </div>
                    <div class="recording-info">
                        <div class="recording-title" title="{{ rec.title }}">{{ rec.title }}</div>
                        <div class="recording-meta">
                            <div class="recording-date">{{ rec.date | date:'d MMM yyyy, HH:mm' }}</div>
                            <div class="recording-genre">{{ rec.genre }}</div>
                            <div class="recording-duration">{{ rec.duration | formatDuration }}</div>
                        </div>
                    </div>
                </div>
                <div class="progress-bar" ng-click="seekAudio(rec, $event)">
                    <div class="progress-fill" ng-class="{'audio': rec.type === 'audio'}" ng-style="{width: rec.progress + '%'}"></div>
                </div>
                <div class="recording-actions">
                    <div class="play-controls">
                        <button class="play-btn" ng-click="playPause(rec, $event)" ng-class="{playing: rec.isPlaying, 'midi': rec.type === 'midi', 'audio': rec.type === 'audio'}">
                            <i class="fas" ng-class="{'fa-play': !rec.isPlaying, 'fa-pause': rec.isPlaying}"></i>
                        </button>
                        <button class="waveform-btn" ng-if="rec.type === 'midi'" ng-click="showMidiVisualizer(rec, $event)">Visualizar</button>
                        <span class="waveform-btn-audio" ng-if="rec.type === 'audio'">Audio</span>
                    </div>
                    <div class="menu-actions">
                        <button class="menu-btn" ng-click="toggleMenu(rec, $event)"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="dropdown-menu" ng-class="{show: rec.showMenu}">
                            <div class="dropdown-item">Publicar</div>
                            <div class="dropdown-item delete" ng-click="deleteRecording(rec, $event)">Eliminar</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="empty-state" ng-if="(recordings | filter:filters).length === 0">
                <div class="empty-icon"><i class="fas fa-folder-open"></i></div>
                <h3 class="empty-title">No hay grabaciones</h3>
                <p class="empty-description">Prueba a grabar algo nuevo.</p>
            </div>
        </div>
    </div>
    
    <audio id="audioPlayer" style="display: none;"></audio>

    <div class="modal-overlay" ng-class="{show: isMidiModalVisible}" ng-click="hideMidiModal()">
        <div class="modal-content" ng-click="$event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-music"></i> Visualizador MIDI <span class="title-text" title="{{ currentMidi.title }}">{{ currentMidi.title }}</span></div>
                <button class="modal-close-btn" ng-click="hideMidiModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="visualizer-container"><midi-visualizer id="recordingVisualizer" type="waterfall"></midi-visualizer></div>
            <div class="player-container"><midi-player id="recordingPlayer" sound-font visualizer="#recordingVisualizer"></midi-player></div>
        </div>
    </div>
    
    <div id="recordingReviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Grabación MIDI Completa</h2>
                <button class="modal-close-btn" id="closeMidiReviewBtn">&times;</button>
            </div>
            <p>Tu grabación está lista. Escúchala y luego guárdala o descártala.</p>
            <div class="visualizer-container">
                <midi-visualizer type="waterfall" id="reviewVisualizer"></midi-visualizer>
                <midi-player id="reviewPlayer" sound-font visualizer="#reviewVisualizer"></midi-player>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-discard" id="discardMidiBtn">Descartar</button>
                <button class="modal-btn modal-btn-save" id="saveMidiBtn">Guardar</button>
            </div>
        </div>
    </div>

    <div id="audioReviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Grabación de Audio Completa</h2>
                <button class="modal-close-btn" id="closeAudioReviewBtn">&times;</button>
            </div>
            <p>Tu grabación de audio está lista para ser previsualizada.</p>
            <div class="audio-player-container">
                <audio id="audioReviewPlayer" controls></audio>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-discard" id="discardAudioBtn">Descartar</button>
                <button class="modal-btn modal-btn-save" id="saveAudioBtn">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const app = angular.module('recordingApp', []);
        
        app.filter('formatDuration', function() {
            return function(seconds) {
                if (isNaN(seconds) || seconds < 0) return '00:00';
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            };
        });

        app.controller('recordingCtrl', function($scope, $interval) {
            $scope.recordings = [
                { id: 1, title: 'Prelude Op.28 N.4 - F. Chopin', date: new Date('2025-09-09T14:30:00'), duration: 165, type: 'midi', genre: 'Románticismo', progress: 0, isPlaying: false, url: "https://assets.codepen.io/81395/chopin.mid" },
                { id: 2, title: 'Nocturne Op.9 N.2 - F. Chopin', date: new Date('2025-10-03T10:15:00'), duration: 390, type: 'audio', genre: 'Románticismo', progress: 0, isPlaying: false, url: "https://dashboard.mozartacademy.mx/media/chopinop9n2.mp3" },
                { id: 3, title: 'Sonata K.545 - W. A. Mozart', date: new Date('2025-08-28T15:30:00'), duration: 442, type: 'audio', genre: 'Clásico', progress: 0, isPlaying: false, url: "https://dashboard.mozartacademy.mx/media/mozartk545.mp3" }
            ];
            $scope.filters = { title: '' };
            $scope.sortOrder = '-date';
            
            // --- Lógica de reproducción y seek de audio ---
            const audioPlayer = document.getElementById('audioPlayer');
            let currentlyPlaying = null;
            $scope.playPause = function(rec, event) { /* ... sin cambios ... */ };
            $scope.seekAudio = function(rec, event) { /* ... sin cambios ... */ };
            audioPlayer.addEventListener('play', () => { if (currentlyPlaying) { $scope.$apply(() => { currentlyPlaying.isPlaying = true; }); } });
            audioPlayer.addEventListener('pause', () => { if (currentlyPlaying) { $scope.$apply(() => { currentlyPlaying.isPlaying = false; }); } });
            audioPlayer.addEventListener('timeupdate', () => { if (currentlyPlaying && currentlyPlaying.type === 'audio') { $scope.$apply(() => { currentlyPlaying.progress = (audioPlayer.currentTime / audioPlayer.duration) * 100; }); } });
            audioPlayer.addEventListener('ended', () => { if (currentlyPlaying) { $scope.$apply(() => { currentlyPlaying.isPlaying = false; currentlyPlaying.progress = 0; currentlyPlaying = null; }); } });
            
            // --- Lógica de UI y Modales existentes ---
            $scope.deleteRecording = function(rec, event) { /* ... sin cambios ... */ };
            $scope.toggleMenu = function(rec, event) { /* ... sin cambios ... */ };
            $scope.isMidiModalVisible = false; $scope.currentMidi = null;
            const existingMidiPlayer = document.querySelector('#recordingPlayer');
            const existingMidiVisualizer = document.querySelector('#recordingVisualizer');
            $scope.showMidiVisualizer = function(rec, event) { /* ... sin cambios ... */ };
            $scope.hideMidiModal = function() { /* ... sin cambios ... */ };

            // ===================================================================
            // LÓGICA DE GRABACIÓN UNIFICADA (MIDI Y AUDIO)
            // ===================================================================
            let currentRecordingMode = ''; // 'midi' o 'audio'
            let isRecording = false;
            let startTime = 0;

            // Variables MIDI
            let midiAccess, midiInput = null, midiDevices = [];
            let recordedEvents = [], lastMidiBuffer = null;

            // Variables Audio
            let mediaRecorder, audioChunks = [], lastAudioBlob = null;

            // DOM Elements
            const midiStatusEl = document.getElementById('midiStatus');
            const recordBtn = document.getElementById('recordBtn');
            const recordBtnSpan = document.getElementById('recordBtnSpan');
            const recordIcon = document.getElementById('recordIcon');
            const deviceSelector = document.getElementById('deviceSelector');
            // Modales
            const midiReviewModal = document.getElementById('recordingReviewModal');
            const audioReviewModal = document.getElementById('audioReviewModal');
            
            // --- Inicialización y Detección de Modo ---
            async function initializeSystem() {
                try {
                    midiAccess = await navigator.requestMIDIAccess();
                    if (midiAccess.inputs.size > 0) {
                        setupMidiMode();
                    } else {
                        setupAudioMode();
                    }
                } catch (error) {
                    console.warn('No se pudo acceder a MIDI, activando modo de audio.', error);
                    setupAudioMode();
                }
                recordBtn.addEventListener('click', toggleRecording);
            }

            function setupMidiMode() {
                currentRecordingMode = 'midi';
                deviceSelector.style.display = 'block';
                recordIcon.className = 'fas fa-music';
                recordBtnSpan.textContent = 'Grabar MIDI';
                midiStatusEl.textContent = 'Modo MIDI activado.';
                
                updateDeviceList();
                deviceSelector.addEventListener('change', updateMIDIConnection);
                document.getElementById('closeMidiReviewBtn').addEventListener('click', () => midiReviewModal.classList.remove('show'));
                document.getElementById('discardMidiBtn').addEventListener('click', () => midiReviewModal.classList.remove('show'));
                document.getElementById('saveMidiBtn').addEventListener('click', saveMidiRecording);
            }

            function setupAudioMode() {
                currentRecordingMode = 'audio';
                deviceSelector.style.display = 'none';
                recordIcon.className = 'fas fa-microphone-alt';
                recordBtnSpan.textContent = 'Grabar Audio';
                midiStatusEl.textContent = 'Modo de grabación: Audio';
                recordBtn.disabled = false;

                document.getElementById('closeAudioReviewBtn').addEventListener('click', () => audioReviewModal.classList.remove('show'));
                document.getElementById('discardAudioBtn').addEventListener('click', () => audioReviewModal.classList.remove('show'));
                document.getElementById('saveAudioBtn').addEventListener('click', saveAudioRecording);
            }

            // --- Control General de Grabación ---
            function toggleRecording() {
                if (isRecording) {
                    currentRecordingMode === 'midi' ? stopMidiRecording() : stopAudioRecording();
                } else {
                    currentRecordingMode === 'midi' ? startMidiRecording() : startAudioRecording();
                }
            }
            
            function updateUIRecording(isStarting) {
                isRecording = isStarting;
                recordBtn.classList.toggle('recording', isStarting);
                const actionText = isStarting ? 'Detener' : (currentRecordingMode === 'midi' ? 'Grabar MIDI' : 'Grabar Audio');
                recordBtnSpan.textContent = actionText;
                midiStatusEl.textContent = isStarting ? 'Grabando...' : (currentRecordingMode === 'midi' ? `Conectado a: ${midiInput.name}` : 'Modo de grabación: Audio');
            }

            // --- Lógica Específica de MIDI ---
            function updateDeviceList() { /* ... sin cambios ... */ }
            function updateMIDIConnection() { /* ... sin cambios ... */ }
            function handleMIDIMessage(event) { /* ... sin cambios ... */ }

            function startMidiRecording() {
                recordedEvents = [];
                startTime = Date.now();
                updateUIRecording(true);
            }
            function stopMidiRecording() {
                updateUIRecording(false);
                if (recordedEvents.length > 0) {
                    lastMidiBuffer = createSimpleMIDIFile(recordedEvents);
                    document.getElementById('reviewPlayer').src = URL.createObjectURL(new Blob([lastMidiBuffer]));
                    midiReviewModal.classList.add('show');
                } else { alert("No se grabó ningún evento MIDI."); }
            }
            function saveMidiRecording() { /* ... sin cambios ... */ }
            function createSimpleMIDIFile(events) { /* ... sin cambios ... */ }
            function toVariableLengthQuantity(value) { /* ... sin cambios ... */ }
            
            // --- Lógica Específica de Audio ---
            async function startAudioRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        lastAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        document.getElementById('audioReviewPlayer').src = URL.createObjectURL(lastAudioBlob);
                        audioReviewModal.classList.add('show');
                        // Detener los tracks del micrófono
                        stream.getTracks().forEach(track => track.stop());
                    };
                    startTime = Date.now();
                    mediaRecorder.start();
                    updateUIRecording(true);
                } catch (err) {
                    alert("Error al acceder al micrófono. Asegúrate de dar los permisos necesarios.");
                    console.error("Error en getUserMedia:", err);
                }
            }
            function stopAudioRecording() {
                if(mediaRecorder && mediaRecorder.state !== "inactive") {
                    mediaRecorder.stop();
                }
                updateUIRecording(false);
            }
            function saveAudioRecording() {
                const title = prompt("Introduce un título para la grabación de audio:", "Mi Grabación de Voz");
                if (title && lastAudioBlob) {
                    const durationInMs = Date.now() - startTime;
                    const newId = $scope.recordings.length > 0 ? Math.max(...$scope.recordings.map(r => r.id)) + 1 : 1;
                    const newRecording = {
                        id: newId, title: title, date: new Date(),
                        duration: Math.round(durationInMs / 1000),
                        type: 'audio', genre: 'Grabación', progress: 0, isPlaying: false,
                        url: URL.createObjectURL(lastAudioBlob)
                    };
                    $scope.$apply(() => { $scope.recordings.push(newRecording); });
                    audioReviewModal.classList.remove('show');
                } else if (!title) { alert("Guardado cancelado."); }
            }

            // --- Inicializar todo el sistema ---
            initializeSystem();

            // Copia aquí las funciones completas que marqué como "sin cambios"
            $scope.playPause = function(rec, event) {
                event.stopPropagation();
                if (rec.type === 'midi') { $scope.showMidiVisualizer(rec, event); return; }
                if (currentlyPlaying === rec) {
                    if (rec.isPlaying) { audioPlayer.pause(); } else { audioPlayer.play(); }
                } else {
                    if (currentlyPlaying) { currentlyPlaying.isPlaying = false; currentlyPlaying.progress = 0; }
                    audioPlayer.pause();
                    currentlyPlaying = rec;
                    if (!rec.url) { alert("Esta grabación no tiene un archivo de audio asociado."); return; }
                    audioPlayer.src = rec.url;
                    audioPlayer.play();
                }
            };
            $scope.seekAudio = function(rec, event) {
                if (rec.type !== 'audio' || !rec.url) return;
                const progressBar = event.currentTarget;
                const rect = progressBar.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = Math.max(0, Math.min(1, clickX / rect.width));
                const newTime = rec.duration * percentage;
                if (currentlyPlaying !== rec) {
                    if (currentlyPlaying) { currentlyPlaying.isPlaying = false; currentlyPlaying.progress = 0; }
                    currentlyPlaying = rec;
                    audioPlayer.src = rec.url;
                }
                audioPlayer.currentTime = newTime;
                rec.progress = percentage * 100;
                audioPlayer.play();
            };
            $scope.deleteRecording = function(rec, event) {
                event.stopPropagation();
                if (confirm(`¿Estás seguro de que quieres eliminar "${rec.title}"?`)) {
                    const index = $scope.recordings.findIndex(r => r.id === rec.id);
                    if (index > -1) { $scope.recordings.splice(index, 1); }
                }
            };
            $scope.toggleMenu = function(rec, event) {
                event.stopPropagation();
                const currentMenuState = rec.showMenu;
                $scope.recordings.forEach(r => r.showMenu = false);
                rec.showMenu = !currentMenuState;
            };
            $scope.showMidiVisualizer = function(rec, event) {
                event.stopPropagation();
                if (rec.type !== 'midi') return;
                $scope.currentMidi = rec;
                existingMidiPlayer.src = rec.url;
                existingMidiVisualizer.src = rec.url;
                $scope.isMidiModalVisible = true;
                if (currentlyPlaying) { currentlyPlaying.isPlaying = false; currentlyPlaying.progress = 0; audioPlayer.pause(); currentlyPlaying = null; }
            };
            $scope.hideMidiModal = function() {
                if ($scope.isMidiModalVisible) {
                    existingMidiPlayer.stop(); existingMidiPlayer.src = ""; existingMidiVisualizer.src = "";
                    $scope.isMidiModalVisible = false; $scope.currentMidi = null;
                }
            };
            function updateDeviceList() {
                deviceSelector.innerHTML = '<option value="">-- Selecciona Dispositivo --</option>';
                midiDevices = [];
                const inputs = midiAccess.inputs.values();
                for (const input of inputs) {
                    midiDevices.push(input);
                    deviceSelector.innerHTML += `<option value="${input.id}">${input.name}</option>`;
                }
                updateMIDIConnection();
            }
            function updateMIDIConnection() {
                const deviceId = deviceSelector.value;
                if (midiInput) { midiInput.onmidimessage = null; midiInput = null; }
                if (deviceId) {
                    midiInput = midiDevices.find(device => device.id === deviceId);
                    if (midiInput) {
                        midiInput.onmidimessage = handleMIDIMessage;
                        midiStatusEl.textContent = `Conectado a: ${midiInput.name}`;
                        recordBtn.disabled = false;
                        return;
                    }
                }
                midiStatusEl.textContent = 'Ningún dispositivo MIDI seleccionado.';
                recordBtn.disabled = true;
            }
            function handleMIDIMessage(event) {
                if (!isRecording) return;
                const commandType = event.data[0] & 0xF0;
                if ((commandType === 0x90 || commandType === 0x80) && event.data[1] !== undefined) {
                    recordedEvents.push({ data: event.data, timestamp: Date.now() - startTime });
                }
            }
            function saveMidiRecording() {
                const title = prompt("Introduce un título para la grabación MIDI:", "Mi Pieza de Piano");
                if (title && lastMidiBuffer) {
                    const durationInMs = recordedEvents.length > 0 ? recordedEvents[recordedEvents.length - 1].timestamp : 0;
                    const newId = $scope.recordings.length > 0 ? Math.max(...$scope.recordings.map(r => r.id)) + 1 : 1;
                    const newRecording = {
                        id: newId, title: title, date: new Date(),
                        duration: Math.round(durationInMs / 1000),
                        type: 'midi', genre: 'Grabación', progress: 0, isPlaying: false,
                        url: URL.createObjectURL(new Blob([lastMidiBuffer]))
                    };
                    $scope.$apply(() => { $scope.recordings.push(newRecording); });
                    midiReviewModal.classList.remove('show');
                } else if (!title) { alert("Guardado cancelado."); }
            }
            function createSimpleMIDIFile(events) {
                const header = new Uint8Array([0x4D, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x01, 0x01, 0xE0]);
                let trackData = [0x00, 0xFF, 0x51, 0x03, 0x0F, 0x42, 0x40];
                let lastTime = 0;
                for (const event of events) {
                    const deltaTime = Math.round(event.timestamp / 2);
                    const deltaTimeVar = toVariableLengthQuantity(deltaTime - lastTime);
                    lastTime = deltaTime;
                    trackData.push(...deltaTimeVar);
                    trackData.push(...event.data);
                }
                trackData.push(0x00, 0xFF, 0x2F, 0x00);
                const trackLength = trackData.length;
                const trackHeader = new Uint8Array([0x4D, 0x54, 0x72, 0x6B, (trackLength >> 24) & 0xFF, (trackLength >> 16) & 0xFF, (trackLength >> 8) & 0xFF, trackLength & 0xFF]);
                const midiData = new Uint8Array(header.length + trackHeader.length + trackData.length);
                midiData.set(header, 0);
                midiData.set(trackHeader, header.length);
                midiData.set(new Uint8Array(trackData), header.length + trackHeader.length);
                return midiData.buffer;
            }
            function toVariableLengthQuantity(value) {
                let result = [];
                let buffer = value & 0x7F;
                while ((value >>= 7) > 0) {
                    buffer <<= 8;
                    buffer |= 0x80;
                    buffer += (value & 0x7F);
                }
                while (true) {
                    result.push(buffer & 0xFF);
                    if (buffer & 0x80) { buffer >>= 8; } else { break; }
                }
                return result;
            }
        });
    </script>
</body>
</html>
